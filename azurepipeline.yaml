# azure-pipelines.yml

trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: imageRepository
    value: 'secure-app'
  - name: imageTag
    value: '$(Build.BuildId)'
  - name: helmChartPath
    value: '$(Build.SourcesDirectory)/secure-app'

stages:
  - stage: Build
    displayName: 'Build and Push Container Image'
    jobs:
      - job: BuildImage
        displayName: 'Build Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              command: build
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              tags: |
                $(imageTag)
                latest

          - task: AzureCLI@2
            displayName: 'Login to ACR'
            inputs:
              azureSubscription: 'azureServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(acrName)

          - task: Docker@2
            displayName: 'Push to ACR'
            inputs:
              command: push
              repository: $(acrLoginServer)/$(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: 'dockerRegistryServiceConnection'
              tags: |
                $(imageTag)
                latest

  - stage: Deploy
    displayName: 'Deploy to AKS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToAKS
        displayName: 'Deploy using Helm and ArgoCD'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Get AKS Credentials'
                  inputs:
                    azureSubscription: 'azureServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az aks get-credentials \
                        --resource-group $(resourceGroupName) \
                        --name $(aksClusterName) \
                        --overwrite-existing

                - task: HelmDeploy@0
                  displayName: 'Helm install'
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: 'azureServiceConnection'
                    azureResourceGroup: '$(resourceGroupName)'
                    kubernetesCluster: '$(aksClusterName)'
                    namespace: 'production'
                    command: 'upgrade'
                    chartType: 'FilePath'
                    chartPath: '$(helmChartPath)'
                    releaseName: 'secure-app'
                    overrideValues: |
                      image.repository=$(acrLoginServer)/$(imageRepository)
                      image.tag=$(imageTag)
                      replicaCount=1
                    arguments: '--install --create-namespace --wait --timeout 5m'

              
 
